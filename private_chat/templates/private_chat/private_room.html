{% extends 'base.html' %} {% load static %} {% block title %}Private_Chat
{%endblock title %} {% block head %}
<link rel="stylesheet" href="{% static 'css/room.css' %}" />
{% endblock head %} {% block body %}
<style type="text/css">
  .profile-image{
		width: 33px;
		height: 33px;
		margin-top: 0px;
		margin-bottom: auto;
	}
  .profile-image:hover{
		cursor: pointer;
	}
  .friend-container:hover{
		background: rgba(180, 180 ,180, 80);
		cursor: pointer;
	}
	.friends-list-container{
		max-height: 500px;
		overflow-y: scroll;
	}
</style>

<div class="container my-2">
  <div class="row">
    <div class="card col-8 px-0" id="id_chatroom_card">
      <div class="card-header" id="{{room_id}}">
        <a class="d-flex flex-row" href="#" target="_blank" id="id_user_info_container">
        <img class="profile-image rounded-circle img-fluid" id="id_other_user_pimage" src="{% static 'images/default_profile.png'%}">
        <h3 class="ml-2" id="id_other_username">
          
        </h3>
        
        <span id="id_status" class="p-2 mx-4 my-3 bg-danger border border-light rounded-circle"></span>
        </a>
      </div>
      <div class="card-body ">
        <span class="invisible" id="page_number">1</span>
        <div class="spinner invisible spinner-border mx-auto">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div id="chat-area" class="d-flex flex-column overflow-auto py-3">
          <!-- <p class="d-flex justify-content-end  mb-2">
                        <span class="">This is right</span><span class="mx-2">: Harsh </span>
                    </p>
                    <p class="d-flex justify-content-start mb-2">
                        <span class="mx-2">Admin :</span><span class=""> This is left</span>
                    </p> -->
        </div>
        <!-- <textarea name="" class="p-2" id="chat-area" cols="80" rows="25" disabled style="resize: none;"></textarea><br> -->
        <div class="row">
          <div class="col-10">
            <input class="form-control" type="text" id="message" />
          </div>
          <div class="col-2">
            <input
              class="btn btn-primary"
              type="button"
              id="send-btn"
              value="SEND"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="card col-3 px-0">
      <div class="card-header">Friends:</div>
      <div class="card-body chats">
        <div class="d-flex flex-column friends-list-container">
          {% for x in m_from_f %}
          <div class="d-flex flex-row p-2 friend-container flex-grow-1" onClick="onSelectFriend('{{x.friend.id}}')" id="friend_{{ x.friend.id }}">
            <img class="profile-image rounder-circle img-fluid" id="friend_img_{{x.friend.id}}" src="{% static 'images/default_profile.png'%}" alt="">
            <div class="d-flex flex-column">
              <span class="username-span">{{ x.friend.username }}</span>
              <span class="message-span">{{ x.message|truncatechars:20 }}</span>
            </div>
          </div>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Client Error MODAL -->
<button type="button" id="id_trigger_client_error_modal" class="d-none btn btn-primary" data-toggle="modal" data-target="#id_client_error_modal">
</button>
<div class="modal fade" id="id_client_error_modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Socket Client Error</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="id_client_error_modal_body">Something went wrong.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="id_client_error_modal_close_btn">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Client Error MODAL -->

{% endblock body %} {% block script %}
<script src="{% static 'js/reconnecting-websocket.js' %}"></script>
{% include 'private_chat/snippets/create_or_return_private_chat.html'%}
<script>
  let csrfmiddlewaretoken = "{{ csrf_token }}"
  let roomId = "{{ room_id }}"
  let socket = null
  let chatWindow = document.getElementById("chat-area");
  
  onStart();
  function onStart(){
    {%if not room_id and m_from_f %}
      onSelectFriend("{{m_from_f.0.friend.id}}")
    {% else %}
      setupWebSocket(roomId)
    {% endif %}
  }

  function onSelectFriend(userId){
		createOrReturnPrivateChat(userId, csrfmiddlewaretoken)
	}

  // var spinner = document.querySelector(".spinner");

  // function leaveRoom() {
  //   socket.send(
  //     JSON.stringify({
  //       command: "leave_room",
  //       data: "",
  //     })
  //   );
  //   window.location.replace("http://" + window.location.host);
  // }

  
  // chatWindow.addEventListener("scroll", function () {
    //   if (Math.abs(chatWindow.scrollTop) == 0) {
      //     getPreviousChatMessages();
      //   }
      // });
      
  function closeWebSocket(){
    if(socket != null){
      socket.close()
      socket = null
    }
  }

  function setupWebSocket(roomId){
    let user = "{{ request.user }}";
    closeWebSocket();
    url = `ws://${window.location.host}/ws/private/room/${roomId}/`;

    socket = new WebSocket(url);

    socket.onopen = function open() {
      console.log("WebSocket Connection Open.");
      socket.send(JSON.stringify({ "room_id": roomId, "command": "join_room" }));
    };

    if (socket.readyState == WebSocket.OPEN) {
      socket.onopen();
    }

    socket.onmessage = function (e) {
      const data = JSON.parse(e.data);

      // Handling Errors
      if(data.error){
        console.log("Error: " + data.error + " " + data.message)
        showClientErrorModal(data.message)
        return;
      }

      // Handling Join in Clients perspective
      if(data.join) {
        console.log("Joining room " + data.join)
        socket.send(JSON.stringify({"command":"get_user_info", "room_id": roomId}))
        getPreviousChatMessages()
      }

      // Handling Leave
      if(data.leave) {
        console.log("Leaving room " + e.leave)
      }

      // Handle user_info payload
      if(data.user_info) {
        handleUserInfo(data.user_info)
      }

      if(data.msg_type == 0 || data.msg_type == 1 || data.msg_type == 2) {
        appendChatMessage(data, true)
        // create_message(data, true)
      }
      if(data.messages_payload) {
        handleLoadMessageEvent(data["messages"], )
      }
    };

    socket.onerror = function (e) {
      console.log("WebSocket Error: ");
      console.log(e);
    };

    socket.onclose = function (e) {
      console.log("WebSocket Closed: ");
      console.log(e);
    };
  }

  function handleUserInfo(userInfo) {
    document.getElementById("id_user_info_container").href="{% url 'account:profile' user_id=124231 %}".replace("124231", userInfo['id'])
    document.getElementById("id_other_username").innerHTML= userInfo["username"]
  }

  function showClientErrorModal(message){
    alert(message)
    document.getElementById("id_client_error_modal_body").innerHTML = message
    document.getElementById("id_trigger_client_error_modal").click()
  }

  function scrollDown() {
    let xH =  chatWindow.scrollHeight;
    chatWindow.scrollTo(0, xH);
  }

  function appendChatMessage(data, isNewMessage) {
    let msg_type = data["msg_type"]
    let message = data["message"]
    let author = data["username"]
    let user = "{{request.user}}"

    switch(msg_type){
      case 0:
        createMessage(message, author, user, isNewMessage)
        break;
      case 1:
        // User joined room
        createConnectedDisconnectedMessage(msg_type, message, author, user)
        break;
      case 2:
        // User leave room
        createConnectedDisconnectedMessage(msg_type, message, author, user)
        break;
    }
      
  }
    
    function createMessage(message, author, current_user, isNewMessage) {
      
      let p_tag = document.createElement("p");
      p_tag.classList.add("my-2", "bg-secondary", "p-2");
      
      let span_name = document.createElement("span");
      span_name.classList.add("mx-2");
      
      let span_msg = document.createElement("span");
      span_msg.innerText = message;
      span_msg.classList.add("text-break");
      
      if (author === current_user) {
        p_tag.classList.add("send");
        span_name.classList.add("text-info");
        span_msg.classList.add("text-end");
        span_name.innerText = " : You";
        // span_name.classList.add("rtl");
        // span_msg.classList.add("rtl");
        p_tag.appendChild(span_msg);
        p_tag.appendChild(span_name);
      } else {
        p_tag.classList.add("reply");
        span_name.classList.add("text-warning");
        span_name.innerText = author + " : ";
        p_tag.appendChild(span_name);
        p_tag.appendChild(span_msg);
      }
      if (!isNewMessage) {
        document
        .querySelector("#chat-area")
        .insertBefore(p_tag, chatWindow.firstChild);
      } else {
        document.querySelector("#chat-area").appendChild(p_tag);
        scrollDown();
      }
    }
    
  function createConnectedDisconnectedMessage(msg_type, message, author, user){
    if(author === user) return;
    let status = document.getElementById("id_status");
    // TODO : Fix bug in online status 
    if(msg_type === 1){
      status.classList.remove("bg-danger")
      status.classList.add("bg-success")
    }
    if(msg_type === 2){
      status.classList.remove("bg-success")
      status.classList.add("bg-danger")
    }
    
  }
    
  sendBtn = document.querySelector("#send-btn");
  inputDOM = document.querySelector("#message");
  
  sendBtn.addEventListener("click", (event) => {
    message = inputDOM.value;
    command = "send_room";
    socket.send(
      JSON.stringify({ message: message, command: command, "room_id": roomId })
    );
    inputDOM.value = "";
  });
  
  function setPaginationExhausted() {
    setPageNumber("-1");
  }

  function setPageNumber(pageNumber) {
    document.getElementById("page_number").innerHTML = pageNumber;
  }

  function getPreviousChatMessages() {
    let page_number = document.getElementById("page_number").innerHTML;
    if (page_number != -1) {
      setPageNumber("-1");
      chatWindow.scrollTo(0, 50);
      socket.send(
        JSON.stringify({
          "command": "get_chat_room_messages",
          "room_id": roomId,
          "page_number": page_number,
        })
      );
      if (page_number == -1) {
      }
    }
  }
  
  function handleLoadMessageEvent(messages, page_number) {
    if (messages != null && messages != undefined && messages != "None") {
      setPageNumber(page_number);
      messages.forEach((message) => {
        appendChatMessage(message, false);
      });
      toggleSpinner();
    } else {
      setPaginationExhausted();
    }
  }

  inputDOM.addEventListener("keyup", (event) => {
    if (event.keyCode == 13) {
      sendBtn.click();
    }
  });
  
  function loadMessages() {
    socket.send(JSON.stringify({ command: "load_messages" }));
  }
  
  function toggleSpinner() {
    spinner.classList.toggle("invisible");
  }

</script>

{% endblock script %}
